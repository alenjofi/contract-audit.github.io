
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fine Print Breaker | Contract Risk Auditor</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- jsPDF for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Font Preconnect for CLS Optimization -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              slate: {
                850: '#151e2e',
                900: '#0f172a',
                950: '#020617',
              },
              amber: {
                450: '#F59E0B',
              }
            },
            fontFamily: {
              sans: ['Inter', 'system-ui', 'sans-serif'],
            },
            backgroundImage: {
              'grid-pattern': "linear-gradient(to right, #ffffff05 1px, transparent 1px), linear-gradient(to bottom, #ffffff05 1px, transparent 1px)",
            },
            animation: {
                'spin-slow': 'spin 3s linear infinite',
                'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                'shimmer': 'shimmer 2s linear infinite',
                'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                'float': 'float 3s ease-in-out infinite',
                'fade-in-up': 'fadeInUp 0.7s ease-out forwards',
                'fade-in': 'fadeIn 0.5s ease-out forwards',
            },
            keyframes: {
                shimmer: {
                    '0%': { backgroundPosition: '-1000px 0' },
                    '100%': { backgroundPosition: '1000px 0' }
                },
                shake: {
                    '0%, 100%': { transform: 'translateX(0)' },
                    '10%, 30%, 50%, 70%, 90%': { transform: 'translateX(-4px)' },
                    '20%, 40%, 60%, 80%': { transform: 'translateX(4px)' },
                },
                float: {
                    '0%, 100%': { transform: 'translateY(0)' },
                    '50%': { transform: 'translateY(-10px)' },
                },
                fadeInUp: {
                    '0%': { opacity: '0', transform: 'translateY(20px)' },
                    '100%': { opacity: '1', transform: 'translateY(0)' },
                },
                fadeIn: {
                    '0%': { opacity: '0' },
                    '100%': { opacity: '1' },
                }
            }
          },
        },
      };
    </script>
    
    <style>
      body { 
        font-family: 'Inter', sans-serif; 
        background-color: #020617; 
        color: #f8fafc;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden; /* Prevent horizontal scroll shifts */
      }
      
      /* CLS Fix: Ensure root occupies full height immediately */
      #root {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .bg-grid {
        background-size: 40px 40px;
        mask-image: linear-gradient(to bottom, transparent, 10%, white, 90%, transparent);
        -webkit-mask-image: linear-gradient(to bottom, transparent, 5%, white, 95%, transparent);
      }
      .glass-panel {
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      }
      .cursor-copy {
        cursor: copy;
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #0f172a; 
      }
      ::-webkit-scrollbar-thumb {
        background: #334155; 
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #475569; 
      }
      
      @keyframes loading {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(300%); }
      }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { GoogleGenAI, Type } from "@google/genai";
        const { useState, useRef, useEffect } = React;

        // --- ICONS (SVG Components) ---
        const IconUpload = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
        );
        const IconShieldCheck = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>
        );
        const IconFileText = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
        );
        const IconAlertCircle = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
        );
        const IconCheck = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="20 6 9 17 4 12"/></svg>
        );
        const IconAlertTriangle = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>
        );
        const IconChevronDown = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>
        );
        const IconChevronUp = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m18 15-6-6-6 6"/></svg>
        );
        const IconCheckCircle2 = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>
        );
        const IconArrowRight = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
        );
        const IconScale = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>
        );
        const IconLoader2 = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        );
        const IconShield = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10Z"/></svg>
        );
        const IconMessageSquare = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        );
        const IconCopy = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
        );
        const IconBriefcase = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
        );
        const IconUser = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        );
        const IconKey = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="7.5" cy="15.5" r="5.5"/><path d="m21 2-9.6 9.6"/><path d="m15.5 7.5 3 3L22 7l-3-3"/></svg>
        );
        const IconHome = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        );
        const IconScan = ({ className }) => (
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><rect width="7" height="7" x="8.5" y="8.5" rx="1"/></svg>
        );
        const IconDownload = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
        );
        const IconSparkles = ({ className }) => (
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>
        );


        // --- CONSTANTS ---
        const SAMPLE_CONTRACT_TEXT = `
INDEPENDENT CONTRACTOR AGREEMENT (PREDATORY SAMPLE)

1. TERM AND TERMINATION
This Agreement shall commence on the Effective Date and continue indefinitely. The Client may terminate this Agreement at any time, for any reason or no reason ("At Will"), immediately upon written notice to the Contractor. The Contractor must provide 60 days' written notice to terminate. No severance or notice pay shall be provided to Contractor.

2. EXCLUSIVITY AND NON-COMPETE
During the term of this Agreement and for a period of twenty-four (24) months following its termination, Contractor agrees not to engage in any employment, consulting, or other business activity that competes with the Client's business, worldwide.

3. INTELLECTUAL PROPERTY
Contractor agrees that all work product, including but not limited to notes, records, drawings, designs, inventions, improvements, developments, and trade secrets conceived, made, or discovered by Contractor, solely or in collaboration with others, during the term of this Agreement, whether or not directly related to the Client's business, shall be the sole and exclusive property of the Client. This includes personal side projects developed on Contractor's own time and equipment.

4. PAYMENT TERMS
Client shall pay Contractor within ninety (90) days of receipt of a valid invoice (Net 90). Client reserves the right to deduct a 5% administrative processing fee from all invoices.

5. INDEMNIFICATION
Contractor agrees to indemnify, defend, and hold harmless the Client from and against any and all claims, demands, liabilities, costs, or expenses, including attorney's fees, arising out of or related to the performance of services under this Agreement, regardless of whether such claims are caused in whole or in part by the negligence of the Client.
`;


        // --- SERVICES ---
        const SYSTEM_INSTRUCTION = `
You are a senior contract lawyer who fiercely protects the "little guy" (freelancers, tenants, junior employees). 
Your job is to audit contracts and find "Traps," "Hidden Costs," and "Red Flags" that could hurt the signatory.
Do not just summarize. You are an aggressive auditor.

Look specifically for:
1. "At will" termination clauses without severance.
2. Non-compete clauses that are overly broad (time or geography).
3. Hidden fees, rent escalation clauses, or automatic renewals.
4. IP ownership traps (where the company owns side projects).
5. Indemnification clauses that are one-sided.

You must output valid JSON.
The "risk_score" should be between 0 (Very Safe) and 100 (Extremely Dangerous).
"critical_warnings" should contain the specific bad clauses found.
"eli5_explanation" means "Explain Like I'm 5" - translate the legalese into simple, blunt English.
`;

        const REBUTTAL_INSTRUCTION = `
You are a fiercely protective lawyer representing a freelancer or employee. 
Write a professional, polite, but firm email rebuttal regarding a specific contract clause. 
Your goal is to negotiate a fairer term without killing the deal. 
Keep the rebuttal under 100 words. 
Focus on mutual fairness.
`;

        const REWRITE_INSTRUCTION = `
You are a fair contract lawyer. Rewrite the following one-sided or unfair clause to be balanced, standard, and fair to both parties. 
Keep it legally sound but remove the predatory language. Ensure mutual rights where applicable.
`;

        const GOOGLE_API_KEY = "AIzaSyDcsfpeuXKVBY5egKAGG_jQEtjs6GNm_yg";
        const ai = new GoogleGenAI({ apiKey: GOOGLE_API_KEY });

        const analyzeContract = async (fileBase64, mimeType, contractType) => {
            const promptContext = `Audit this ${contractType} contract for legal risks. Provide a risk score and a list of red flags specifically for a ${contractType} context.`;
            
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: {
                  parts: [
                    { 
                      inlineData: { 
                        mimeType: mimeType, 
                        data: fileBase64 
                      } 
                    },
                    { 
                      text: promptContext
                    }
                  ]
                },
                config: {
                  systemInstruction: SYSTEM_INSTRUCTION,
                  responseMimeType: "application/json",
                  responseSchema: {
                    type: Type.OBJECT,
                    properties: {
                      risk_score: { type: Type.INTEGER, description: "0-100 risk score where 100 is dangerous" },
                      summary_verdict: { type: Type.STRING, description: "A 2-sentence summary of the overall safety." },
                      hidden_fee_check: { type: Type.BOOLEAN, description: "True if hidden fees exist" },
                      ip_assignment_check: { type: Type.BOOLEAN, description: "True if bad IP clauses exist" },
                      safe_clauses: {
                        type: Type.ARRAY,
                        items: { type: Type.STRING },
                        description: "List of 3 things that are actually standard or safe in this doc."
                      },
                      critical_warnings: {
                        type: Type.ARRAY,
                        items: {
                          type: Type.OBJECT,
                          properties: {
                            title: { type: Type.STRING },
                            description: { type: Type.STRING },
                            severity: { type: Type.STRING, enum: ["CRITICAL", "HIGH", "MODERATE", "LOW"] },
                            clause_reference: { type: Type.STRING, description: "The exact text from the doc" },
                            eli5_explanation: { type: Type.STRING, description: "Simple english explanation" }
                          }
                        }
                      }
                    },
                    required: ["risk_score", "critical_warnings", "summary_verdict"]
                  }
                }
            });

            if (response.text) {
                return JSON.parse(response.text);
            }
            throw new Error("No content generated");
        };

        const generateRebuttal = async (clauseText) => {
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: {
                    parts: [{ text: `Write a rebuttal for this clause: "${clauseText}"` }]
                },
                config: {
                    systemInstruction: REBUTTAL_INSTRUCTION,
                }
            });
            return response.text || "Could not generate rebuttal.";
        };

        const rewriteClause = async (clauseText) => {
            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: {
                    parts: [{ text: `Rewrite this clause to be fair and mutual: "${clauseText}"` }]
                },
                config: {
                    systemInstruction: REWRITE_INSTRUCTION,
                }
            });
            return response.text || "Could not generate rewrite.";
        };

        // --- PDF GENERATION ---
        const generatePDF = (data, fileName, contractType) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;
            const maxLineWidth = pageWidth - margin * 2;
            
            let y = 20;

            // Header
            doc.setFontSize(22);
            doc.setTextColor(40, 40, 40);
            doc.text("Audit Report", margin, y);
            y += 8;

            doc.setFontSize(12);
            doc.setTextColor(128, 128, 128); // Gray
            doc.text(`Fine Print Breaker Analysis`, margin, y);
            y += 15;

            // Metadata
            doc.setFontSize(10);
            doc.setTextColor(60, 60, 60);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, margin, y);
            y += 6;
            doc.text(`File: ${fileName}`, margin, y);
            y += 6;
            doc.text(`Contract Type: ${contractType}`, margin, y);
            y += 15;

            // Score
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text(`Risk Score: ${data.risk_score}/100`, margin, y);
            
            // Draw score indicator (simple rectangle)
            const scoreColor = data.risk_score > 70 ? [244, 63, 94] : (data.risk_score > 30 ? [251, 191, 36] : [16, 185, 129]);
            doc.setFillColor(...scoreColor);
            doc.rect(margin + 50, y - 5, 20, 5, 'F');
            y += 15;

            // Summary
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text("Executive Summary", margin, y);
            y += 8;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            const summaryLines = doc.splitTextToSize(data.summary_verdict, maxLineWidth);
            doc.text(summaryLines, margin, y);
            y += summaryLines.length * 5 + 10;

            // Risks
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(`Identified Risks (${data.critical_warnings.length})`, margin, y);
            y += 10;

            data.critical_warnings.forEach((item, index) => {
                // Page break check
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }

                // Title
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                const severityText = item.severity;
                doc.setTextColor(item.severity === 'CRITICAL' ? 220 : 0, 0, 0); // Red if critical
                doc.text(`${index + 1}. ${item.title} [${severityText}]`, margin, y);
                y += 6;

                // Description
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(40, 40, 40);
                const descLines = doc.splitTextToSize(item.description, maxLineWidth);
                doc.text(descLines, margin, y);
                y += descLines.length * 5 + 5;

                // Clause
                doc.setFont(undefined, 'italic');
                doc.setTextColor(100, 100, 100);
                doc.setFontSize(9);
                const clauseLines = doc.splitTextToSize(`"${item.clause_reference}"`, maxLineWidth);
                doc.text(clauseLines, margin, y);
                y += clauseLines.length * 4 + 4;

                // ELI5
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text("Simply Put:", margin, y);
                doc.setFont(undefined, 'normal');
                const eli5Lines = doc.splitTextToSize(item.eli5_explanation, maxLineWidth - 25);
                doc.text(eli5Lines, margin + 20, y); // Indent
                y += eli5Lines.length * 4 + 10;
            });

            // Safe Clauses
            if (y > 240) {
                doc.addPage();
                y = 20;
            }
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(16, 185, 129); // Emerald
            doc.text("Safe Clauses Detected", margin, y);
            y += 8;
            doc.setFontSize(10);
            doc.setTextColor(60, 60, 60);
            doc.setFont(undefined, 'normal');
            data.safe_clauses.forEach(clause => {
                doc.text(`â€¢ ${clause}`, margin, y);
                y += 6;
            });

            doc.save('fine-print-breaker-report.pdf');
        };


        // --- COMPONENTS ---

        // Toast Component
        const Toast = ({ message, show }) => (
            <div className={`fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 transition-all duration-300 ${show ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4 pointer-events-none'}`}>
                <div className="bg-slate-900 text-slate-200 px-4 py-2 rounded-lg shadow-2xl border border-slate-700 flex items-center gap-2 text-sm font-medium">
                     <IconCheck className="w-4 h-4 text-emerald-500" />
                     {message}
                </div>
            </div>
        );

        // 1. Contract Type Selector
        const ContractTypeSelector = ({ selected, onSelect }) => {
            const types = [
                { 
                    id: 'Freelance', 
                    icon: IconUser, 
                    label: 'Freelance', 
                    sub: 'Contractor',
                    desc: 'Checks for IP theft, non-competes, and late payment clauses.' 
                },
                { 
                    id: 'Employment', 
                    icon: IconBriefcase, 
                    label: 'Employment', 
                    sub: 'Full-time',
                    desc: 'Reviews termination rights, severance packages, and benefits.' 
                },
                { 
                    id: 'Lease', 
                    icon: IconHome, 
                    label: 'Lease', 
                    sub: 'Rental',
                    desc: 'Audits rent escalation, deposit returns, and repair duties.' 
                },
                { 
                    id: 'NDA', 
                    icon: IconKey, 
                    label: 'NDA', 
                    sub: 'Privacy',
                    desc: 'Analyzes confidentiality scope, duration, and fair exclusions.' 
                },
            ];

            return (
                <div className="w-full max-w-xl mx-auto mb-6 relative z-30">
                    <label className="block text-sm font-medium text-slate-400 mb-3 uppercase tracking-wider text-center">
                        Select Contract Type
                    </label>
                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                        {types.map((type) => {
                            const Icon = type.icon;
                            const isSelected = selected === type.id;
                            return (
                                <button
                                    key={type.id}
                                    onClick={() => onSelect(type.id)}
                                    className={`relative group flex flex-col items-center justify-center p-3 rounded-xl border transition-all duration-200
                                        ${isSelected 
                                            ? 'bg-amber-500 text-slate-900 border-amber-400 shadow-[0_0_20px_rgba(245,158,11,0.3)] scale-[1.02]' 
                                            : 'bg-slate-900/50 text-slate-400 border-slate-800 hover:bg-slate-800 hover:border-slate-700'
                                        }`}
                                >
                                    <Icon className={`w-6 h-6 mb-2 ${isSelected ? 'text-slate-900' : 'text-slate-500 group-hover:text-slate-300'}`} />
                                    <span className="text-sm font-bold leading-none">{type.label}</span>
                                    <span className={`text-[10px] mt-1 ${isSelected ? 'text-slate-800/80' : 'text-slate-600'}`}>{type.sub}</span>
                                    
                                    {/* Tooltip */}
                                    <div className="absolute bottom-full mb-3 left-1/2 -translate-x-1/2 w-48 p-3 bg-slate-800/95 backdrop-blur-sm border border-slate-700 text-slate-200 text-xs rounded-lg shadow-xl opacity-0 group-hover:opacity-100 transition-all duration-200 pointer-events-none z-50 text-center transform group-hover:-translate-y-1">
                                        <p className="leading-snug">{type.desc}</p>
                                        <div className="absolute top-full left-1/2 -translate-x-1/2 border-8 border-transparent border-t-slate-800/95"></div>
                                    </div>
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // 2. File Upload
        const FileUpload = ({ onFileSelect, isAnalyzing, contractType, setContractType, onLoadSample }) => {
            const [dragActive, setDragActive] = useState(false);
            const [status, setStatus] = useState('idle');
            const [progress, setProgress] = useState(0);
            const [loadingText, setLoadingText] = useState('');
            const [errorMessage, setErrorMessage] = useState(null);
            const [isAgreed, setIsAgreed] = useState(false);
            const inputRef = useRef(null);

            const MAX_FILE_SIZE = 10 * 1024 * 1024;
            const ALLOWED_EXTENSIONS = ['pdf', 'docx', 'txt', 'md'];
            const ALLOWED_MIME_TYPES = [
                'application/pdf',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'text/plain',
                'text/markdown'
            ];

            const validateAndProcessFile = (file) => {
                setErrorMessage(null);
                setProgress(0);

                if (file.size > MAX_FILE_SIZE) {
                    setErrorMessage(`File exceeds 10MB limit (${(file.size / (1024 * 1024)).toFixed(1)}MB)`);
                    setStatus('error');
                    return;
                }

                const isMimeValid = file.type === '' || ALLOWED_MIME_TYPES.some(type => file.type === type);
                const fileNameParts = file.name.split('.');
                const fileExtension = fileNameParts.length > 1 ? fileNameParts.pop()?.toLowerCase() : '';
                const isExtensionValid = fileExtension && ALLOWED_EXTENSIONS.includes(fileExtension);

                if (!isExtensionValid && !isMimeValid) {
                    const displayExt = fileExtension ? `.${fileExtension}` : 'This file type';
                    setErrorMessage(`${displayExt} is not supported. Please use PDF, DOCX, or TXT.`);
                    setStatus('error');
                    return;
                }

                // Start Visual Loading Sequence
                setStatus('reading');
                
                const reader = new FileReader();

                reader.onprogress = (event) => {
                    if (event.lengthComputable) {
                        const percent = Math.round((event.loaded / event.total) * 100);
                        const visualPercent = Math.min(percent, 80); // Cap at 80% to allow final processing step
                        setProgress(visualPercent);
                    }
                };

                reader.onload = () => {
                    setProgress(100);
                    setStatus('complete');
                    setTimeout(() => {
                        onFileSelect(file);
                    }, 800);
                };

                reader.onerror = () => {
                    setErrorMessage("Failed to read file.");
                    setStatus('error');
                };

                // Enhanced Simulator for file reading animation
                let simulatedProgress = 0;
                const interval = setInterval(() => {
                    simulatedProgress += 2;
                    setProgress(prev => {
                        const next = Math.min(Math.max(prev, simulatedProgress), 95);
                        
                        // Dynamic text based on progress
                        if(next < 25) setLoadingText('Scanning structure...');
                        else if(next < 50) setLoadingText('Analyzing density...');
                        else if(next < 75) setLoadingText('Sanitizing contents...');
                        else setLoadingText('Finalizing upload...');
                        
                        return next;
                    });
                    
                    if (simulatedProgress >= 100) {
                         clearInterval(interval);
                    }
                }, 30);
                
                // Read the file in background
                reader.readAsDataURL(file);
            };

            const handleDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (status !== 'idle' && status !== 'error') return;
                
                if (e.type === "dragenter" || e.type === "dragover") {
                    setDragActive(true);
                } else if (e.type === "dragleave") {
                    setDragActive(false);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);
                if (status !== 'idle' && status !== 'error') return;
                if (!isAgreed) return;

                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    validateAndProcessFile(e.dataTransfer.files[0]);
                }
            };

            const handleChange = (e) => {
                e.preventDefault();
                if (e.target.files && e.target.files[0]) {
                    validateAndProcessFile(e.target.files[0]);
                }
            };

            const onButtonClick = () => {
                if (isAgreed) {
                    inputRef.current?.click();
                }
            };
            
            const onContainerClick = () => {
                if (status === 'idle' && isAgreed) {
                    inputRef.current?.click();
                }
            };

            const reset = (e) => {
                e.stopPropagation();
                setStatus('idle');
                setErrorMessage(null);
                setProgress(0);
                if (inputRef.current) inputRef.current.value = '';
            };

            return (
                <div className="w-full max-w-xl mx-auto space-y-4">
                    
                    <ContractTypeSelector selected={contractType} onSelect={setContractType} />

                     {/* Mandatory Checkbox */}
                    <div className={`flex items-start gap-3 p-4 border rounded-lg transition-colors duration-200 ${isAgreed ? 'bg-slate-900/50 border-slate-800' : 'bg-amber-950/20 border-amber-500/30'}`}>
                        <input 
                        type="checkbox" 
                        id="legal-disclaimer" 
                        checked={isAgreed} 
                        onChange={(e) => setIsAgreed(e.target.checked)}
                        className="mt-1 w-4 h-4 rounded border-slate-600 text-amber-500 focus:ring-amber-500 bg-slate-800 cursor-pointer"
                        />
                        <label htmlFor="legal-disclaimer" className={`text-sm cursor-pointer select-none transition-colors ${isAgreed ? 'text-slate-300' : 'text-amber-100/80'}`}>
                        I understand this AI tool is for <strong className={`${isAgreed ? 'text-slate-100' : 'text-amber-200'}`}>informational purposes only</strong> and does not constitute legal advice. I will consult a qualified attorney for any binding agreements.
                        </label>
                    </div>

                    <div 
                        onClick={onContainerClick}
                        className={`relative group flex flex-col items-center justify-center w-full h-80 rounded-2xl border-2 transition-all duration-300 ease-out overflow-hidden
                        ${status === 'error'
                            ? 'border-red-500/50 bg-red-500/5 cursor-default animate-shake'
                            : !isAgreed 
                              ? 'border-slate-800 bg-slate-900/20 opacity-70 cursor-not-allowed border-dashed'
                            : dragActive 
                            ? 'border-amber-400 bg-amber-400/5 scale-[1.02] shadow-[0_0_30px_rgba(245,158,11,0.15)] cursor-copy border-dashed' 
                            : 'border-slate-700 bg-slate-900/40 hover:border-slate-600 hover:bg-slate-900/60 cursor-pointer border-dashed hover:border-solid'
                        }
                        ${(isAnalyzing || status === 'reading' || status === 'complete') ? 'pointer-events-none' : ''}
                        `}
                        onDragEnter={handleDrag}
                        onDragLeave={handleDrag}
                        onDragOver={handleDrag}
                        onDrop={handleDrop}
                    >
                        <div className="absolute inset-0 bg-grid-pattern opacity-10 pointer-events-none"></div>

                        {/* Error State */}
                        {status === 'error' && (
                            <div className="text-center p-8 z-10 animate-in zoom-in-95 duration-200">
                                <div className="p-3 bg-red-500/10 rounded-full inline-flex mb-4 border border-red-500/20 shadow-[0_0_15px_rgba(239,68,68,0.2)]">
                                    <IconAlertCircle className="w-8 h-8 text-red-500" />
                                </div>
                                <h3 className="text-lg font-medium text-slate-200 mb-2">Upload Failed</h3>
                                <p className="text-sm text-red-400 mb-6 max-w-[250px] mx-auto">{errorMessage}</p>
                                <button 
                                type="button"
                                onClick={reset}
                                className="pointer-events-auto px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-200 text-sm font-medium rounded-lg border border-slate-700 transition-colors"
                                >
                                Try Again
                                </button>
                            </div>
                        )}

                        {/* Loading / Complete State */}
                        {(status === 'reading' || status === 'complete') && (
                            <div className="w-full max-w-xs p-6 z-10 text-center animate-in fade-in duration-300">
                                <div className="mb-6 flex justify-center relative">
                                    {status === 'complete' ? (
                                    <div className="p-3 bg-emerald-500/10 rounded-full border border-emerald-500/20 shadow-[0_0_20px_rgba(16,185,129,0.3)] animate-in zoom-in-50 duration-300 scale-125">
                                        <IconCheck className="w-8 h-8 text-emerald-500" />
                                    </div>
                                    ) : (
                                    <div className="relative">
                                        <div className="absolute inset-0 bg-amber-500/20 blur-xl rounded-full animate-pulse"></div>
                                        <div className="p-4 bg-slate-800 rounded-full border border-amber-500/30 relative z-10">
                                            <IconScan className="w-8 h-8 text-amber-500 animate-[spin_3s_linear_infinite]" />
                                        </div>
                                    </div>
                                    )}
                                </div>
                                <h3 className="text-base font-medium text-slate-200 mb-2 transition-all duration-300 h-6">
                                    {status === 'complete' ? 'Ready for Analysis' : loadingText}
                                </h3>
                                
                                <div className="w-full h-1.5 bg-slate-800/80 rounded-full overflow-hidden mt-4 relative backdrop-blur-sm border border-white/5">
                                    <div 
                                        className={`h-full rounded-full transition-all duration-100 ease-out relative overflow-hidden ${status === 'complete' ? 'bg-emerald-500' : 'bg-gradient-to-r from-amber-600 to-amber-400'}`}
                                        style={{ width: `${progress}%` }}
                                    >
                                        <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent w-full -translate-x-full animate-[shimmer_1.5s_infinite]" style={{ display: status === 'complete' ? 'none' : 'block' }}></div>
                                    </div>
                                </div>
                                <p className="text-xs text-slate-500 mt-2 font-mono tabular-nums">{progress}%</p>
                            </div>
                        )}

                        {/* Idle State (Standard or Dragging) */}
                        {status === 'idle' && (
                            <div className={`text-center p-8 z-10 flex flex-col items-center transition-opacity duration-300 ${!isAgreed ? 'opacity-40 grayscale' : 'opacity-100'}`}>
                                
                                {dragActive ? (
                                    <div className="animate-in zoom-in-90 duration-200">
                                        <div className="mb-6 flex justify-center">
                                            <div className="p-4 rounded-full border bg-amber-500/10 border-amber-500/50 shadow-[0_0_20px_rgba(245,158,11,0.2)] animate-bounce">
                                                <IconDownload className="w-8 h-8 text-amber-400" />
                                            </div>
                                        </div>
                                        <h3 className="text-lg font-bold text-amber-400 tracking-tight">Drop Document Here</h3>
                                    </div>
                                ) : (
                                    <>
                                        <div className="mb-6 flex justify-center">
                                            <div className={`p-4 rounded-full border shadow-xl transition-all duration-300 ${isAgreed ? 'bg-slate-800/80 border-slate-700 group-hover:scale-110 group-hover:border-amber-500/30 group-hover:shadow-amber-500/10' : 'bg-slate-900 border-slate-800'}`}>
                                                <IconUpload className={`w-6 h-6 transition-colors duration-300 ${isAgreed ? 'text-amber-400' : 'text-slate-600'}`} />
                                            </div>
                                        </div>
                                        
                                        <div className="space-y-3">
                                            <h3 className="text-lg font-medium text-slate-200 tracking-tight group-hover:text-white transition-colors">
                                                 {isAgreed ? 'Drag & Drop contract file' : 'Accept Terms to Upload'}
                                            </h3>
                                            
                                            <div className="flex gap-2 justify-center py-1">
                                                <span className="px-2 py-1 rounded-md bg-slate-800 border border-slate-700 text-[10px] font-bold text-slate-400 uppercase tracking-wider group-hover:border-slate-600 transition-colors">PDF</span>
                                                <span className="px-2 py-1 rounded-md bg-slate-800 border border-slate-700 text-[10px] font-bold text-slate-400 uppercase tracking-wider group-hover:border-slate-600 transition-colors">DOCX</span>
                                                <span className="px-2 py-1 rounded-md bg-slate-800 border border-slate-700 text-[10px] font-bold text-slate-400 uppercase tracking-wider group-hover:border-slate-600 transition-colors">TXT</span>
                                            </div>
                                            
                                            <div className="flex justify-center mt-1">
                                                <span className="inline-flex items-center px-2 py-0.5 rounded text-[10px] font-medium text-slate-500/80">
                                                Max 10MB
                                                </span>
                                            </div>
                                        </div>

                                        <div className="mt-8">
                                            <button 
                                                type="button"
                                                disabled={!isAgreed}
                                                onClick={(e) => {
                                                    e.stopPropagation();
                                                    onButtonClick();
                                                }}
                                                className={`px-5 py-2.5 text-sm font-medium rounded-lg border transition-all shadow-sm
                                                    ${isAgreed 
                                                      ? 'bg-slate-800 hover:bg-slate-700 text-slate-200 border-slate-700 hover:shadow-md hover:border-slate-600' 
                                                      : 'bg-slate-900 text-slate-600 border-slate-800 cursor-not-allowed'}`}
                                            >
                                                Browse Files
                                            </button>
                                        </div>
                                    </>
                                )}
                            </div>
                        )}

                        <input
                            ref={inputRef}
                            type="file"
                            className="hidden"
                            accept=".pdf,.txt,.docx,.doc,.md"
                            onChange={handleChange}
                            disabled={!isAgreed}
                        />
                    </div>

                    {/* Load Sample Button */}
                    <div className="flex justify-center pt-2">
                         <button
                            type="button"
                            onClick={(e) => {
                                e.preventDefault();
                                onLoadSample();
                            }}
                            className="group inline-flex items-center gap-2 text-xs font-medium text-slate-500 hover:text-amber-400 transition-colors p-2 rounded-lg hover:bg-slate-900/50"
                        >
                            <IconSparkles className="w-3.5 h-3.5" />
                            <span>Don't have a file?</span>
                            <span className="underline decoration-slate-700 underline-offset-2 group-hover:decoration-amber-500/50">Try with Sample Contract</span>
                        </button>
                    </div>

                </div>
            );
        };

        // 3. Risk Gauge (Custom SVG)
        const RiskGauge = ({ score }) => {
            let color = '#10b981'; // Green
            let text = 'Safe';
            let subtext = 'Standard Terms';
            
            if (score > 30) {
                color = '#fbbf24'; // Amber-400
                text = 'Caution';
                subtext = 'Review Needed';
            }
            if (score > 70) {
                color = '#f43f5e'; // Rose-500
                text = 'High Risk';
                subtext = 'Dangerous Clauses';
            }

            // SVG Arc math
            const radius = 85;
            const center = 100;
            const circumference = Math.PI * radius;
            const dashArray = circumference;
            const dashOffset = circumference - (score / 100) * circumference;

            return (
                <div className="relative w-full h-56 flex flex-col items-center justify-center">
                    <svg width="240" height="140" viewBox="0 0 200 120" className="overflow-visible">
                        {/* Background Track */}
                        <path 
                            d="M 15 100 A 85 85 0 0 1 185 100" 
                            fill="none" 
                            stroke="#1e293b" 
                            strokeWidth="18" 
                            strokeLinecap="round" 
                        />
                        {/* Progress Bar */}
                        <path 
                            d="M 15 100 A 85 85 0 0 1 185 100" 
                            fill="none" 
                            stroke={color} 
                            strokeWidth="18" 
                            strokeLinecap="round"
                            strokeDasharray={dashArray}
                            strokeDashoffset={dashOffset}
                            className="transition-all duration-1000 ease-out"
                        />
                    </svg>
                    
                    <div className="absolute top-[65%] left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center pb-4">
                        <div className="text-4xl font-bold text-white tracking-tighter tabular-nums">
                            {score}
                        </div>
                        <div className="text-xs font-bold uppercase tracking-widest mt-1" style={{ color }}>
                            {text}
                        </div>
                        <div className="text-[10px] text-slate-500 mt-1 font-medium">
                            {subtext}
                        </div>
                    </div>
                </div>
            );
        };

        // 4. Risk Card
        const RiskCard = ({ item, triggerToast }) => {
            const [expanded, setExpanded] = useState(false);
            const [rebuttal, setRebuttal] = useState(null);
            const [isGenerating, setIsGenerating] = useState(false);
            const [copied, setCopied] = useState(false);

            // Rewrite State
            const [rewritten, setRewritten] = useState(null);
            const [isRewriting, setIsRewriting] = useState(false);
            const [rewriteCopied, setRewriteCopied] = useState(false);

            const handleGenerateRebuttal = async (e) => {
                e.stopPropagation();
                if (rebuttal) {
                    setExpanded(true); // Just show it if already generated
                    return;
                }
                
                setExpanded(true);
                setIsGenerating(true);
                try {
                    const text = await generateRebuttal(item.clause_reference);
                    setRebuttal(text);
                } catch (error) {
                    setRebuttal("Error generating rebuttal. Please try again.");
                } finally {
                    setIsGenerating(false);
                }
            };

            const handleRewrite = async (e) => {
                e.stopPropagation();
                if (rewritten) {
                    setExpanded(true);
                    return;
                }
                setExpanded(true);
                setIsRewriting(true);
                try {
                    const text = await rewriteClause(item.clause_reference);
                    setRewritten(text);
                } catch (error) {
                    setRewritten("Error generating rewrite.");
                } finally {
                    setIsRewriting(false);
                }
            };

            const copyToClipboard = () => {
                if (rebuttal) {
                    navigator.clipboard.writeText(rebuttal);
                    setCopied(true);
                    triggerToast("Copied to clipboard");
                    setTimeout(() => setCopied(false), 2000);
                }
            };

            const copyRewrite = () => {
                if (rewritten) {
                    navigator.clipboard.writeText(rewritten);
                    setRewriteCopied(true);
                    triggerToast("Fair clause copied");
                    setTimeout(() => setRewriteCopied(false), 2000);
                }
            };

            return (
                <div className={`group rounded-lg border bg-slate-900/50 transition-all duration-200
                    ${expanded ? 'border-amber-500/30 bg-slate-900' : 'border-slate-800 hover:border-slate-700'}`}>
                    
                    <div className="flex">
                        <div className={`w-1.5 rounded-l-lg ${
                            item.severity === 'CRITICAL' ? 'bg-red-500' : 
                            item.severity === 'HIGH' ? 'bg-orange-500' : 'bg-amber-400'
                        }`}></div>

                        <div className="flex-1 p-5">
                            <div className="flex justify-between items-start gap-4">
                                <div>
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className={`text-[10px] font-bold uppercase tracking-wider px-2 py-0.5 rounded border ${
                                            item.severity === 'CRITICAL' ? 'bg-red-500/10 text-red-400 border-red-500/20' : 
                                            item.severity === 'HIGH' ? 'bg-orange-500/10 text-orange-400 border-orange-500/20' : 
                                            'bg-amber-400/10 text-amber-400 border-amber-400/20'
                                        }`}>
                                        {item.severity} Risk
                                        </span>
                                    </div>
                                    <h4 className="font-semibold text-slate-100 text-lg leading-tight">{item.title}</h4>
                                </div>
                                <div className="hidden sm:flex items-center gap-2">
                                    <button
                                        onClick={handleGenerateRebuttal}
                                        className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-amber-600/20 hover:text-amber-400 border border-slate-700 hover:border-amber-500/30 text-xs font-medium text-slate-300 transition-all"
                                    >
                                        {isGenerating ? <IconLoader2 className="w-3.5 h-3.5 animate-spin" /> : <IconMessageSquare className="w-3.5 h-3.5" />}
                                        <span>{isGenerating ? 'Drafting...' : 'Generate Rebuttal'}</span>
                                    </button>
                                     <button
                                        onClick={handleRewrite}
                                        className="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-slate-800 hover:bg-emerald-600/20 hover:text-emerald-400 border border-slate-700 hover:border-emerald-500/30 text-xs font-medium text-slate-300 transition-all"
                                    >
                                        {isRewriting ? <IconLoader2 className="w-3.5 h-3.5 animate-spin" /> : <IconSparkles className="w-3.5 h-3.5" />}
                                        <span>{isRewriting ? 'Rewriting...' : 'Rewrite Clause'}</span>
                                    </button>
                                </div>
                            </div>
                            
                            <p className="mt-2 text-slate-400 text-sm leading-relaxed">
                                {item.description}
                            </p>
                            
                            <div className="mt-4 pt-4 border-t border-slate-800/50 flex items-center justify-between">
                                <button 
                                onClick={() => setExpanded(!expanded)}
                                className="flex items-center text-xs font-medium text-slate-400 hover:text-white transition-colors group-hover:text-slate-300"
                                >
                                {expanded ? <IconChevronUp className="h-3.5 w-3.5 mr-1.5"/> : <IconChevronDown className="h-3.5 w-3.5 mr-1.5"/>}
                                {expanded ? "Hide Details" : "Expand Details"}
                                </button>
                                <div className="sm:hidden flex gap-3">
                                    <button
                                        onClick={handleGenerateRebuttal}
                                        className="flex items-center gap-1.5 text-xs font-medium text-amber-500"
                                    >
                                        {isGenerating ? 'Drafting...' : 'Rebuttal'}
                                    </button>
                                     <button
                                        onClick={handleRewrite}
                                        className="flex items-center gap-1.5 text-xs font-medium text-emerald-500"
                                    >
                                        {isRewriting ? 'Rewriting...' : 'Rewrite'}
                                    </button>
                                </div>
                            </div>

                            {expanded && (
                                <div className="mt-4 grid gap-4 animate-in fade-in slide-in-from-top-1 duration-300">
                                    <div className="p-4 bg-slate-950 rounded border border-slate-800">
                                        <p className="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-2">Original Clause</p>
                                        <p className="text-sm font-mono text-slate-400 italic leading-relaxed">"{item.clause_reference}"</p>
                                    </div>
                                    <div className="p-4 bg-amber-950/20 rounded border border-amber-500/10">
                                        <p className="text-[10px] text-amber-500 uppercase font-bold tracking-wider mb-2">Explain Like I'm 5</p>
                                        <p className="text-sm text-slate-200 leading-relaxed">{item.eli5_explanation}</p>
                                    </div>

                                    {(rewritten || isRewriting) && (
                                        <div className="p-4 bg-emerald-950/20 rounded border border-emerald-500/20 relative">
                                            <p className="text-[10px] text-emerald-400 uppercase font-bold tracking-wider mb-2 flex items-center gap-2">
                                                <IconSparkles className="w-3 h-3" />
                                                Fair & Mutual Version
                                            </p>
                                            {isRewriting ? (
                                                <div className="space-y-2">
                                                    <div className="h-3 bg-slate-700/50 rounded w-3/4 animate-pulse"></div>
                                                    <div className="h-3 bg-slate-700/50 rounded w-full animate-pulse"></div>
                                                </div>
                                            ) : (
                                                <>
                                                    <p className="text-sm text-slate-200 leading-relaxed whitespace-pre-line">{rewritten}</p>
                                                    <button 
                                                        onClick={copyRewrite}
                                                        className="absolute top-3 right-3 p-1.5 text-slate-400 hover:text-white hover:bg-emerald-900/50 rounded-md transition-colors"
                                                        title="Copy to clipboard"
                                                    >
                                                        {rewriteCopied ? <IconCheck className="w-4 h-4 text-emerald-500" /> : <IconCopy className="w-4 h-4" />}
                                                    </button>
                                                </>
                                            )}
                                        </div>
                                    )}

                                    {(rebuttal || isGenerating) && (
                                        <div className="p-4 bg-slate-800/50 rounded border border-slate-700 relative">
                                            <p className="text-[10px] text-indigo-400 uppercase font-bold tracking-wider mb-2">AI Suggested Rebuttal</p>
                                            {isGenerating ? (
                                                <div className="space-y-2">
                                                    <div className="h-3 bg-slate-700 rounded w-3/4 animate-pulse"></div>
                                                    <div className="h-3 bg-slate-700 rounded w-full animate-pulse"></div>
                                                    <div className="h-3 bg-slate-700 rounded w-2/3 animate-pulse"></div>
                                                </div>
                                            ) : (
                                                <>
                                                    <p className="text-sm text-slate-300 leading-relaxed whitespace-pre-line">{rebuttal}</p>
                                                    <button 
                                                        onClick={copyToClipboard}
                                                        className="absolute top-3 right-3 p-1.5 text-slate-400 hover:text-white hover:bg-slate-700 rounded-md transition-colors"
                                                        title="Copy to clipboard"
                                                    >
                                                        {copied ? <IconCheck className="w-4 h-4 text-emerald-500" /> : <IconCopy className="w-4 h-4" />}
                                                    </button>
                                                </>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 5. Dashboard
        const Dashboard = ({ result, fileName, contractType, reset, triggerToast }) => {
            // No locking state anymore - Fully Free
            
            return (
                <div className="max-w-6xl mx-auto space-y-8 animate-fade-in-up duration-700">
                    <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
                        {/* Left Column */}
                        <div className="md:col-span-4 space-y-6">
                            <div className="glass-panel rounded-xl p-6 relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-4 opacity-10">
                                    <IconAlertTriangle className="w-24 h-24 text-white" />
                                </div>
                                <h3 className="text-slate-400 text-xs font-bold uppercase tracking-widest mb-4">Risk Audit Score</h3>
                                <RiskGauge score={result.risk_score} />
                                
                                <div className="mt-6 space-y-3">
                                    <div className={`flex items-center justify-between p-3 rounded-lg border ${result.hidden_fee_check ? 'bg-red-500/10 border-red-500/20' : 'bg-slate-800/50 border-slate-700'}`}>
                                        <span className="text-sm text-slate-300">Hidden Fees</span>
                                        {result.hidden_fee_check ? <IconAlertTriangle className="w-4 h-4 text-red-400" /> : <IconCheckCircle2 className="w-4 h-4 text-emerald-500" />}
                                    </div>
                                    <div className={`flex items-center justify-between p-3 rounded-lg border ${result.ip_assignment_check ? 'bg-red-500/10 border-red-500/20' : 'bg-slate-800/50 border-slate-700'}`}>
                                        <span className="text-sm text-slate-300">IP Ownership</span>
                                        {result.ip_assignment_check ? <IconAlertTriangle className="w-4 h-4 text-red-400" /> : <IconCheckCircle2 className="w-4 h-4 text-emerald-500" />}
                                    </div>
                                </div>
                            </div>

                            <div className="glass-panel rounded-xl p-6">
                                <h3 className="text-emerald-400 text-xs font-bold uppercase tracking-widest mb-4 flex items-center gap-2">
                                <IconShieldCheck className="w-4 h-4" /> 
                                Safe Clauses
                                </h3>
                                <ul className="space-y-4">
                                {result.safe_clauses.map((clause, idx) => (
                                    <li key={idx} className="flex gap-3 text-sm text-slate-300 leading-snug">
                                    <div className="mt-0.5 min-w-[16px]">
                                        <IconCheckCircle2 className="w-4 h-4 text-emerald-500/50" />
                                    </div>
                                    <span>{clause}</span>
                                    </li>
                                ))}
                                </ul>
                            </div>
                        </div>

                        {/* Right Column */}
                        <div className="md:col-span-8 space-y-6">
                            <div className="glass-panel rounded-xl p-8 border-l-4 border-amber-400">
                                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                                    <h2 className="text-xl font-bold text-white">Executive Summary</h2>
                                    <button
                                        onClick={() => generatePDF(result, fileName, contractType)}
                                        className="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-amber-500 hover:bg-amber-400 text-slate-900 text-xs font-bold transition-all shadow-lg shadow-amber-500/20"
                                    >
                                        <IconDownload className="w-4 h-4" />
                                        Download Full Report
                                    </button>
                                </div>
                                <p className="text-slate-300 leading-relaxed">
                                {result.summary_verdict}
                                </p>
                            </div>

                            <div className="flex items-center justify-between pt-4">
                                <h3 className="text-lg font-semibold text-white flex items-center gap-2">
                                Identified Risks 
                                <span className="px-2 py-0.5 rounded-full bg-slate-800 text-xs text-slate-400 border border-slate-700">
                                    {result.critical_warnings.length} Found
                                </span>
                                </h3>
                            </div>

                            <div className="space-y-4">
                                {result.critical_warnings.map((risk, idx) => (
                                <RiskCard key={idx} item={risk} triggerToast={triggerToast} />
                                ))}

                                {result.critical_warnings.length === 0 && (
                                <div className="p-12 rounded-xl border border-dashed border-slate-700 bg-slate-900/30 text-center">
                                    <IconCheckCircle2 className="w-12 h-12 text-emerald-500/50 mx-auto mb-4" />
                                    <h3 className="text-lg font-medium text-slate-300">No Critical Risks Detected</h3>
                                    <p className="text-slate-500 mt-2 text-sm">This document appears to follow standard industry terms.</p>
                                </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 6. Main App
        const App = () => {
            const [state, setState] = useState('IDLE'); // IDLE, ANALYZING, RESULTS, ERROR
            const [result, setResult] = useState(null);
            const [fileName, setFileName] = useState('');
            const [errorMsg, setErrorMsg] = useState('');
            const [contractType, setContractType] = useState('Freelance'); // Default
            const [toast, setToast] = useState({ show: false, message: '' });

            const triggerToast = (msg) => {
                setToast({ show: true, message: msg });
                setTimeout(() => {
                    setToast({ show: false, message: '' });
                }, 2000);
            };

            const handleFileSelect = async (file) => {
                // Instantly analyzing
                setState('ANALYZING');
                setFileName(file.name);
                setErrorMsg('');

                try {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = async () => {
                        const base64Data = reader.result?.toString().split(',')[1];
                        const mimeType = file.type || 'application/pdf';

                        if (base64Data) {
                            try {
                                const analysis = await analyzeContract(base64Data, mimeType, contractType);
                                setResult(analysis);
                                setState('RESULTS');
                            } catch (e) {
                                console.error(e);
                                setErrorMsg(e.message || "Analysis failed. Check your file format or try again.");
                                setState('ERROR');
                            }
                        }
                    };
                    reader.onerror = () => {
                        setErrorMsg("Failed to read file.");
                        setState('ERROR');
                    };
                } catch (err) {
                    setErrorMsg("An unexpected error occurred.");
                    setState('ERROR');
                }
            };

            const handleLoadSample = async () => {
                setState('ANALYZING');
                setFileName("predatory_contract_sample.txt");
                setContractType('Freelance');
                setErrorMsg('');

                try {
                    // Convert sample text to base64
                    const base64Data = btoa(SAMPLE_CONTRACT_TEXT);
                    const analysis = await analyzeContract(base64Data, 'text/plain', 'Freelance');
                    setResult(analysis);
                    setState('RESULTS');
                } catch (e) {
                    console.error(e);
                    setErrorMsg("Sample analysis failed. Please try again.");
                    setState('ERROR');
                }
            };

            const reset = () => {
                setState('IDLE');
                setResult(null);
                setFileName('');
            };

            return (
                <div className="min-h-screen bg-slate-950 bg-grid-pattern bg-fixed selection:bg-amber-500/30 pb-20 flex flex-col">
                    
                    {/* Flashing Disclaimer */}
                    <div className="bg-red-500/10 border-b border-red-500/20 text-center py-2 px-4 animate-pulse">
                        <p className="text-xs font-bold text-red-400 uppercase tracking-widest flex items-center justify-center gap-2">
                            <IconAlertCircle className="w-3 h-3" />
                            This is not legal advice. This is an AI opinion. Consult a lawyer.
                        </p>
                    </div>

                    {/* Navbar */}
                    <nav className="border-b border-white/5 bg-slate-950/80 backdrop-blur-xl sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3 cursor-pointer group" onClick={reset}>
                                <div className="bg-amber-500 p-1.5 rounded-lg group-hover:shadow-[0_0_15px_rgba(245,158,11,0.5)] transition-all duration-300">
                                    <IconScale className="h-5 w-5 text-slate-950" />
                                </div>
                                <span className="font-bold text-lg text-slate-100 tracking-tight">Fine Print <span className="text-amber-500">Breaker</span></span>
                            </div>
                            <div className="hidden sm:flex items-center gap-6">
                                <span className="text-xs font-semibold text-slate-500 uppercase tracking-widest">Enterprise Grade Analysis</span>
                            </div>
                        </div>
                    </nav>

                    {/* Main Container */}
                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-20 relative flex-grow w-full">
                        <div className="absolute top-0 left-1/2 -translate-x-1/2 w-full max-w-3xl h-64 bg-amber-500/10 blur-[100px] pointer-events-none rounded-full"></div>

                        {state === 'IDLE' && (
                            /* CLS FIX: Removed 'justify-center', added 'pt-10 md:pt-20' to anchor content to top instead of centering */
                            <div className="flex flex-col items-center min-h-[60vh] space-y-12 animate-fade-in-up duration-700 relative z-10 pt-10 md:pt-20">
                                <div className="text-center space-y-6 max-w-3xl">
                                    <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-900 border border-slate-800 text-xs font-medium text-slate-400 mb-2">
                                        <IconShield className="w-3 h-3 text-emerald-500" />
                                        <span>AI-Powered Legal Defense</span>
                                    </div>
                                    <h1 className="text-5xl md:text-7xl font-bold tracking-tight text-white leading-[1.1]">
                                        Scan Contracts for <br/>
                                        <span className="text-transparent bg-clip-text bg-gradient-to-r from-amber-300 via-amber-500 to-amber-600">Hidden Traps</span>
                                    </h1>
                                    <p className="text-lg md:text-xl text-slate-400 max-w-xl mx-auto leading-relaxed">
                                        Upload your contract for an instant 20-point risk audit based on your contract type. We identify loopholes, hidden fees, and IP theft clauses so you don't have to.
                                    </p>
                                </div>
                                
                                <FileUpload 
                                    onFileSelect={handleFileSelect} 
                                    isAnalyzing={false} 
                                    contractType={contractType}
                                    setContractType={setContractType}
                                    onLoadSample={handleLoadSample}
                                />
                                
                                <div className="pt-8 border-t border-slate-900 w-full max-w-4xl text-center">
                                    <p className="text-xl font-medium text-slate-400 opacity-60">
                                        Built for the 58 Million Freelancers who sign blindly
                                    </p>
                                </div>
                            </div>
                        )}

                        {state === 'ANALYZING' && (
                            <div className="flex flex-col items-center justify-center min-h-[50vh] space-y-10 animate-in zoom-in-95 duration-500 relative z-10">
                                <div className="relative">
                                    <div className="absolute inset-0 bg-amber-500/20 blur-2xl rounded-full animate-pulse"></div>
                                    <div className="relative bg-slate-900 p-6 rounded-2xl border border-slate-800 shadow-2xl">
                                        <IconLoader2 className="h-12 w-12 text-amber-500 animate-spin" />
                                    </div>
                                </div>
                                <div className="text-center space-y-3">
                                    <h2 className="text-2xl font-semibold text-white tracking-tight">Analyzing Document</h2>
                                    <div className="flex items-center gap-2 text-slate-400 bg-slate-900/50 px-4 py-1.5 rounded-full border border-slate-800 mx-auto w-fit">
                                        <IconFileText className="w-4 h-4" />
                                        <span className="text-sm font-mono">{fileName}</span>
                                    </div>
                                     <div className="flex items-center gap-2 text-amber-400 bg-amber-950/20 px-4 py-1.5 rounded-full border border-amber-500/20 mx-auto w-fit">
                                        <IconScale className="w-3.5 h-3.5" />
                                        <span className="text-xs font-bold uppercase tracking-wide">{contractType} Review</span>
                                    </div>
                                </div>
                                
                                <div className="w-full max-w-xs space-y-4">
                                    <div className="h-1 w-full bg-slate-900 rounded-full overflow-hidden">
                                        <div className="h-full bg-amber-500 animate-[loading_2s_ease-in-out_infinite] w-1/3 rounded-full"></div>
                                    </div>
                                    <p className="text-xs text-center text-slate-500 uppercase tracking-widest font-semibold">
                                        Processing Legal Logic...
                                    </p>
                                </div>
                            </div>
                        )}

                        {state === 'ERROR' && (
                            <div className="flex flex-col items-center justify-center min-h-[50vh] text-center space-y-6 relative z-10">
                                <div className="bg-red-500/10 p-6 rounded-2xl border border-red-500/20 shadow-[0_0_30px_rgba(239,68,68,0.1)]">
                                    <IconAlertCircle className="h-10 w-10 text-red-500" />
                                </div>
                                <div className="max-w-md space-y-2">
                                    <h2 className="text-xl font-bold text-white">Analysis Failed</h2>
                                    <p className="text-slate-400 text-sm leading-relaxed">{errorMsg}</p>
                                </div>
                                <button 
                                onClick={reset}
                                className="px-6 py-2.5 bg-slate-800 hover:bg-slate-700 border border-slate-700 rounded-lg text-white text-sm font-medium transition-colors shadow-lg"
                                >
                                Try Another File
                                </button>
                            </div>
                        )}

                        {state === 'RESULTS' && result && (
                            <div className="space-y-8 relative z-10">
                                <div className="flex items-center justify-between pb-6 border-b border-white/5">
                                    <div className="flex items-center gap-4">
                                        <div className="bg-slate-900 p-2.5 rounded-lg border border-slate-800">
                                            <IconFileText className="h-5 w-5 text-amber-500" />
                                        </div>
                                        <div>
                                            <h2 className="text-lg font-bold text-white tracking-tight">Audit Report</h2>
                                            <div className="flex items-center gap-2 text-sm text-slate-500">
                                                <span>{fileName}</span>
                                                <span className="w-1 h-1 rounded-full bg-slate-700"></span>
                                                <span>{contractType}</span>
                                                <span className="w-1 h-1 rounded-full bg-slate-700"></span>
                                                <span>Generated {new Date().toLocaleDateString()}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={reset} 
                                        className="px-4 py-2 text-sm font-medium text-slate-400 hover:text-white border border-slate-800 hover:border-slate-600 rounded-lg transition-colors bg-slate-900/50"
                                    >
                                        New Scan
                                    </button>
                                </div>
                                <Dashboard result={result} fileName={fileName} contractType={contractType} reset={reset} triggerToast={triggerToast} />
                            </div>
                        )}

                        {/* Toast Notification */}
                        <Toast message={toast.message} show={toast.show} />

                    </main>
                    
                    {/* CLS FIX: Added mt-auto to ensure footer is pushed to bottom naturally in flex column */}
                    <footer className="border-t border-white/5 bg-slate-950 py-12 mt-auto">
                        <div className="max-w-7xl mx-auto px-6 text-center space-y-2">
                            <p className="text-slate-600 text-sm">
                                &copy; {new Date().getFullYear()} Fine Print Breaker. 
                            </p>
                            <p className="text-slate-500 text-xs">
                                We do not store your files. Analysis is transient.
                            </p>
                            <p className="text-slate-700 text-xs font-medium uppercase tracking-wider pt-2">
                                Powered by Gemini 2.5 Flash â€¢ Free Tier
                            </p>
                        </div>
                    </footer>
                </div>
            );
        };

        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(
            <React.StrictMode>
                <App />
            </React.StrictMode>
        );
    </script>
    <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "23f9020a624b458c94ef934e6a148e58"}'></script><!-- End Cloudflare Web Analytics -->
</body>
</html>
